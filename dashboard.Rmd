---
title: "United Way Food Insecurity Predictions"
output: 
  flexdashboard::flex_dashboard:
    runtime: shiny
    orientation: row
    vertical_layout: scroll
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#Incorporating Shiny (interactive) components into flexdashboard:
#https://rmarkdown.rstudio.com/flexdashboard/shiny.html#simple_example
library(flexdashboard)
library(ggplot2)
library(dplyr)
library(RColorBrewer)
library(reshape2)
library(tigris)
library(sp)
library(tidycensus)
library(rgeos)#spatial
library(DT)#datatable
library(rmapshaper)


acs <- read.csv("acs_predictions.csv")#read acs data with predictions


#for merging
acs$GEOID <- as.character(paste0(acs$GEOID, substr(acs$X, 13, 13)))
#this is block groups w/in tracts
ia_shp <- readRDS("ia_shp.RDS")#block_groups(state = "IA")  #TIME INTENSIVE 1st run (so each dashboard run)

county_list <- readRDS("county_list.RDS")#unique(counties("Iowa")$NAME)#TIME INTENSIVE 1st run (so each dashboard run)
county_list <- county_list[order(county_list)]
all_counties <-   block_groups(state = 'IA', county = county_list)

ia_shp_join <- left_join(ia_shp, acs, by="GEOID" ) %>%
  rmapshaper::ms_simplify( keep = 0.01, keep_shapes = TRUE)

#for color scale
limit <- c(min(acs$lasso_pred,na.rm=TRUE), max(acs$lasso_pred,na.rm=TRUE))
limit_bin <- c(min(acs$lasso_bin_pred,na.rm=TRUE), max(acs$lasso_bin_pred,na.rm=TRUE))

```

Presence of Food Insecurity
===================================== 

Inputs {.sidebar}
-----------------------------------------------------------------------

```{r, echo=FALSE}
selectInput("county", label = "Select County FIPS:", choices = unique(all_counties$COUNTYFP))

```


Row 
-----------------------------------------------------------------------

### Introduction

Predictions are based on a logistic regression predicting the probability of a household experiencing some level of food insecurity. The LASSO technique is used to select demographic variables that improve out of sample prediction performance. 


Row 
-----------------------------------------------------------------------


### State-level
```{r, echo=FALSE}
cnty_shp_join <- reactive({
  subset(ia_shp_join, COUNTYFP == input$county) 
  #block_groups(state = 'IA', county = input$county)
  })


ggplot(aes(fill  = lasso_bin_pred, colour=lasso_bin_pred),data = ia_shp_join) +
  geom_sf()+
  scale_fill_viridis_c("Predicted \nProbability",limits = limit_bin)+
  scale_colour_viridis_c("Predicted \nProbability",limits = limit_bin)
```

### County-level

```{r, echo=FALSE}
renderPlot({ggplot(aes(fill  = lasso_bin_pred, colour=lasso_bin_pred),data = cnty_shp_join()) +
  geom_sf()+
  scale_fill_viridis_c("Predicted \nProbability",limits = limit_bin)+
  scale_colour_viridis_c("Predicted \nProbability",limits = limit_bin)})

```


Row 
-----------------------------------------------------------------------

### Predictions

```{r, echo=FALSE}
temp1 <- ia_shp_join %>% as.data.frame%>%dplyr::select(c("X", "female", "avg_hhsize", "hispanic",
                                  "black", "kids", "elderly", "education", "employed",
                                  "married", "disability", "lasso_bin_pred"))%>%
                  rename(Location = X, 
                         `Predicted Probability` = lasso_bin_pred)
renderDataTable({
rbind(temp1[which(ia_shp_join$COUNTYFP == input$county),],
      temp1[which(ia_shp_join$COUNTYFP != input$county),])
  
})
```


Food Expenditure
===================================== 

Inputs {.sidebar}
-----------------------------------------------------------------------


```{r, echo=FALSE}
selectInput("county2", label = "Select County FIPS:", choices = unique(all_counties$COUNTYFP))

```

Row 
-----------------------------------------------------------------------

### Introduction

Predictions are based on a linear regression predicting the mean household food expenditure. The LASSO technique is used to select demographic variables that improve out of sample prediction performance. 
Row 
-----------------------------------------------------------------------

###  State-level
```{r,echo=FALSE}
cnty_shp_join2 <- reactive({
  subset(ia_shp_join, COUNTYFP == input$county2) 
  })
ggplot(aes(fill  = lasso_pred, colour=lasso_pred),data = ia_shp_join) +
  geom_sf()+
  scale_fill_viridis_c("Predicted \nExpenditure",limits = limit)+
  scale_colour_viridis_c("Predicted \nExpenditure",limits = limit)
```

### County-level
```{r,echo=FALSE}
renderPlot({
ggplot(aes(fill  = lasso_pred, colour=lasso_pred),data = cnty_shp_join2()) +
  geom_sf()+
  scale_fill_viridis_c("Predicted \nExpenditure",limits = limit)+
  scale_colour_viridis_c("Predicted \nExpenditure",limits = limit)})

```


Row 
-----------------------------------------------------------------------

### Predictions

```{r, echo=FALSE}
temp2 <- ia_shp_join %>%as.data.frame%>% dplyr::select(c("X", "female", "avg_hhsize", "hispanic",
                                  "black", "kids", "elderly", "education", "employed",
                                  "married", "disability", "lasso_pred"))%>%
                  rename(Location = X, 
                         `Predicted Expenditure` = lasso_pred)
renderDataTable({
rbind(temp2[which(ia_shp_join$COUNTYFP == input$county2),],
      temp2[which(ia_shp_join$COUNTYFP != input$county2),])
  
})
```

