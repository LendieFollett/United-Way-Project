---
title: "United Way Food Insecurity Predictions"
output: 
  flexdashboard::flex_dashboard:
    runtime: shiny
    orientation: rows
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#Incorporating Shiny (interactive) components into flexdashboard:
#https://rmarkdown.rstudio.com/flexdashboard/shiny.html#simple_example
library(flexdashboard)
library(ggplot2)
library(dplyr)
library(RColorBrewer)
library(reshape2)
library(BART)
library(reshape2)
library(gridExtra)
library(tigris)
library(sp)
library(tidycensus)
library(rgeos)#spatial

cps <- read.csv("cps(clean).csv")#household level
acs <- read.csv("acs(clean).csv")#aggregated (sums) to census tract

cps_X <- cps %>% 
  dplyr::select("hhsize", "female", "kids", "elderly", "black", "hispanic", "education",
                  "employed", "married", "disability")
acs_X <- acs %>%
  mutate_at(c("female", "kids", "elderly", "black", "hispanic", "education",
              "employed", "married", "disability"), ~ . /  households) %>%
  dplyr::select("avg_hhsize", "female", "kids", "elderly", "black", "hispanic", "education",
                "employed", "married", "disability") %>%
  rename(hhsize = avg_hhsize)

#read models
reg_bin <- readRDS("reg_bin.RDS") #lasso logistic regression
breg_bin <- readRDS("breg_bin.RDS") #BART logistic regression
reg <- readRDS("reg.RDS") #lasso regression
breg <- readRDS("breg.RDS") #BART regression

#add predicted values
acs$olr_bin_pred <- predict(reg_bin, acs_X, type = "response")
acs$bart_bin_pred <- breg_bin$prob.test.mean

acs$olr_pred <- predict(reg, acs_X, type = "response")
acs$bart_pred <- breg$yhat.test.mean

acs$GEOID <- as.character(paste0(acs$GEOID, substr(acs$X, 13, 13)))

ia_shp <- block_groups(state = "IA") #this is block groups w/in tracts

county_list <- unique(counties("Iowa")$NAME)
county_list <- county_list[order(county_list)]
all_counties <-   block_groups(state = 'IA', county = county_list)
```

Predicting Presence of Food Insecurity
===================================== 


Inputs {.sidebar}
-----------------------------------------------------------------------


```{r, echo=FALSE}
selectInput("county", label = "Select County:", choices = unique(all_counties$COUNTYFP))

```

Row {data-height=150}
-----------------------------------------------------------------------

### Introduction

This is a basic start to a dashboard that will contain both visual and tabular/numeric summaries of food insecurity predictions. 


Row {data-height=150}
-----------------------------------------------------------------------

### BART
```{r, echo=FALSE}


cnty_shp <- reactive({
  subset(all_counties, COUNTYFP == input$county)
  #block_groups(state = 'IA', county = input$county)
  })
cnty_shp_join <- reactive({left_join(cnty_shp(), acs, by="GEOID" )})
#for merging - use GEOID
#join onto shape file

ia_shp_join <- left_join(ia_shp, acs, by="GEOID" )


ggplot(aes(fill  = bart_bin_pred, colour=bart_bin_pred),data = ia_shp_join) +
  geom_sf()+
  scale_fill_viridis_c()+
  scale_colour_viridis_c()

```

### County-level
```{r, echo=FALSE}
renderPlot({ggplot(aes(fill  = bart_bin_pred, colour=bart_bin_pred),data = cnty_shp_join()) +
  geom_sf()+
  scale_fill_viridis_c()+
  scale_colour_viridis_c()})

```

Row {data-height=150}
-----------------------------------------------------------------------

### Logistic Regression
```{r, echo=FALSE}

ggplot(aes(fill  = olr_bin_pred, colour=olr_bin_pred),data = ia_shp_join) +
  geom_sf()+
  scale_fill_viridis_c()+
  scale_colour_viridis_c()
```

### County-level

```{r, echo=FALSE}
renderPlot({ggplot(aes(fill  = olr_bin_pred, colour=olr_bin_pred),data = cnty_shp_join()) +
  geom_sf()+
  scale_fill_viridis_c()+
  scale_colour_viridis_c()})

```

Food Expenditure
===================================== 

Inputs {.sidebar}
-----------------------------------------------------------------------


```{r, echo=FALSE}
selectInput("county2", label = "Select County:", choices = unique(all_counties$COUNTYFP))

```

Row {data-height=150}
-----------------------------------------------------------------------

### Introduction

details blah blah

Row {data-height=150}
-----------------------------------------------------------------------
### BART
```{r,echo=FALSE}
#ia_shp <- tracts(state = 'IA') #this is census tracts
cnty_shp2 <- reactive({
  subset(all_counties, COUNTYFP == input$county)
  #block_groups(state = 'IA', county = input$county)
  })
cnty_shp_join2 <- reactive({left_join(cnty_shp(), acs, by="GEOID" )})
#for merging - use GEOID
#join onto shape file

renderPlot({
ggplot(aes(fill  = bart_pred, colour=bart_pred),data = ia_shp_join) +
  geom_sf()+
  scale_fill_viridis_c("Predicted \nProbability")+
  scale_colour_viridis_c("Predicted \nProbability")
})

```

### County-level
```{r,echo=FALSE}
renderPlot({
ggplot(aes(fill  = bart_pred, colour=bart_pred),data = cnty_shp_join2()) +
  geom_sf()+
  scale_fill_viridis_c("Predicted \nProbability")+
  scale_colour_viridis_c("Predicted \nProbability")
})

```

Row {data-height=150}
-----------------------------------------------------------------------

###  Regression
```{r,echo=FALSE}
renderPlot({
ggplot(aes(fill  = olr_pred, colour=olr_pred),data = ia_shp_join) +
  geom_sf()+
  scale_fill_viridis_c("Predicted \nProbability")+
  scale_colour_viridis_c("Predicted \nProbability")})
```

### County-level
```{r,echo=FALSE}
renderPlot({
ggplot(aes(fill  = olr_pred, colour=olr_pred),data = cnty_shp_join2()) +
  geom_sf()+
  scale_fill_viridis_c("Predicted \nProbability")+
  scale_colour_viridis_c("Predicted \nProbability")})

```


Tabular output
===================================== 

```{r}
datatable(data = acs[,c("X","olr_bin_pred", "bart_bin_pred", "olr_pred", "bart_pred")])
```


