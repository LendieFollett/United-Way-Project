---
title: "United Way Food Insecurity Predictions"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: row
    vertical_layout: scroll
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#Xremove state-level maps
#Xround hover output
#Xround predicted probability in table output
#definition of expenditure in the intro page 
#Xmake neighborhood dividers less prominent (white dividers less thick)
#Xcolor to rocket instead of viridis
#consistent color --> goodness color mapping
#(reverse it for the probability scale)
#Probability of being food SECURE
#Xhave GEOID in the table so can look up map locations in table

#Incorporating Shiny (interactive) components into flexdashboard:
#https://rmarkdown.rstudio.com/flexdashboard/shiny.html#simple_example
library(flexdashboard)
library(ggplot2)
library(dplyr)
library(RColorBrewer)
library(reshape2)
library(tigris)
library(sp)
library(tidycensus)
library(rgeos)#spatial
library(DT)#datatable
library(rmapshaper)
library(leaflet)
library(htmltools)
library(totalcensus)

acs <- read.csv("acs_predictions.csv")#read acs data with predictions

#round predictions
acs$lasso_bin_pred <- round(acs$lasso_bin_pred,2)
acs$lasso_pred <- round(acs$lasso_pred,2)

#for merging
acs$GEOID <- as.character(paste0(acs$GEOID, substr(acs$X, 13, 13)))

#this is block groups w/in tracts
ia_shp <- readRDS("ia_shp.RDS")#block_groups(state = "IA")  #TIME INTENSIVE 1st run (so each dashboard run)

county_list <- readRDS("county_list.RDS")#unique(counties("Iowa")$NAME)#TIME INTENSIVE 1st run (so each dashboard run)
county_list <- county_list[order(county_list)]
all_counties <-   block_groups(state = 'IA', county = county_list) #also time intensive...

ia_shp_join <- left_join(ia_shp, acs, by="GEOID" ) %>%
  rmapshaper::ms_simplify( keep = 0.01, keep_shapes = TRUE)

ia_shp_join$COUNTYNAME <- convert_fips_to_names(ia_shp_join$COUNTYFP, states = rep("IA", nrow(ia_shp_join)), geo_header="COUNTY")

ia_shp_join$labels <- paste0(
  "<strong> County: </strong> ",
  ia_shp_join$COUNTYNAME, "<br/> ",
  "<strong> GEOID: </strong> ",
  ia_shp_join$GEOID, "<br/> ",
  "<strong> Food Expenditure: </strong> $",
  ia_shp_join$lasso_pred, "<br/> ",
  "<strong> Food Insecurity: </strong> ",
  ia_shp_join$lasso_bin_pred, "<br/> "
) %>%
  lapply(htmltools::HTML)

#for color scale
limit <- c(min(acs$lasso_pred,na.rm=TRUE), max(acs$lasso_pred,na.rm=TRUE))
limit_bin <- c(min(acs$lasso_bin_pred,na.rm=TRUE), max(acs$lasso_bin_pred,na.rm=TRUE))

pal_bin <- colorBin(
  palette = "YlOrRd", domain = ia_shp_join$lasso_bin_pred,
  bins = seq(0, max(ia_shp_join$lasso_bin_pred, na.rm = TRUE) + .01, by = .05)
)

pal <- colorBin(
  palette = "YlOrRd", domain = ia_shp_join$lasso_pred,
  bins = seq(floor(min(ia_shp_join$lasso_pred, na.rm = TRUE)), floor(max(ia_shp_join$lasso_pred, na.rm = TRUE)) + .1, by = 5)
)

```

Presence of Food Insecurity
===================================== 

Inputs {.sidebar}
-----------------------------------------------------------------------

```{r, echo=FALSE}
selectInput("county", label = "Select County:", choices = unique(ia_shp_join$COUNTYNAME), selected = "Polk County")

```


Row 
-----------------------------------------------------------------------

### Introduction

Predictions are based on a logistic regression predicting the probability of a household experiencing some level of food insecurity. The LASSO technique is used to select demographic variables that improve out of sample prediction performance. Survey sampling weights are used to decrease prediction bias. 


Row 
-----------------------------------------------------------------------


### County-level

```{r, echo=FALSE}
# renderPlot({ggplot(aes(fill  = lasso_bin_pred, colour=lasso_bin_pred),data = cnty_shp_join()) +
#   geom_sf()+
#   scale_fill_viridis_c("Predicted \nProbability",limits = limit_bin)+
#   scale_colour_viridis_c("Predicted \nProbability",limits = limit_bin)})


cnty_shp_join <- reactive({
  subset(ia_shp_join, COUNTYNAME == input$county) 
  #block_groups(state = 'IA', county = input$county)
  })
renderLeaflet({
leaflet(cnty_shp_join(),height=500, width=1000) %>%
  addTiles() %>%
  #setView(lng = 0, lat = 30, zoom = 2) %>%
  addPolygons(
    fillColor = ~ pal_bin(lasso_bin_pred),
    color = "white",
        stroke=FALSE,
    fillOpacity = 0.6,
    label = ~labels,
    highlight = highlightOptions(
      color = "black",
      bringToFront = TRUE
    )
  )%>%
  leaflet::addLegend(
    pal = pal_bin, values = ~lasso_bin_pred,
    opacity = 0.7, title = "Predicted \nProbability",
    position = "topright"
  )
})

```


Row 
-----------------------------------------------------------------------

### Predictions

```{r, echo=FALSE}
temp1 <- ia_shp_join %>% as.data.frame%>%dplyr::select(c("GEOID","lasso_bin_pred", "female", "avg_hhsize", "hispanic",
                                  "black", "kids", "elderly", "education", "employed",
                                  "married", "disability"))%>%
                  rename( 
                         `Predicted Probability` = lasso_bin_pred)
renderDataTable({
rbind(temp1[which(ia_shp_join$COUNTYNAME == input$county),],
      temp1[which(ia_shp_join$COUNTYNAME != input$county),])
  
})
```


Food Expenditure
===================================== 

Inputs {.sidebar}
-----------------------------------------------------------------------


```{r, echo=FALSE}
selectInput("county2", label = "Select County:", choices = unique(ia_shp_join$COUNTYNAME), selected = "Polk County")

```

Row 
-----------------------------------------------------------------------

### Introduction

Predictions are based on a linear regression predicting the mean household food expenditure. The LASSO technique is used to select demographic variables that improve out of sample prediction performance. Survey sampling weights are used to decrease prediction bias.  


Row 
-----------------------------------------------------------------------

### County-level
```{r,echo=FALSE}

cnty_shp_join2 <- reactive({
  subset(ia_shp_join, COUNTYNAME == input$county2) 
  })
renderLeaflet({
leaflet(cnty_shp_join2(),height=500, width=1000) %>%
  addTiles() %>%
  #setView(lng = 0, lat = 30, zoom = 2) %>%
  addPolygons(
    fillColor = ~ pal(lasso_pred),
    stroke=FALSE,
    color = "white",
    fillOpacity = 0.6,
    label = ~labels,
    highlight = highlightOptions(
      color = "black",
      bringToFront = TRUE
    )
  )%>%
  leaflet::addLegend(
    pal = pal, values = ~lasso_pred,
    opacity = 0.7, title = "Predicted \nFood Expenditure",
    position = "topright"
  )
})


```


Row 
-----------------------------------------------------------------------

### Predictions

```{r, echo=FALSE}
temp2 <- ia_shp_join %>%as.data.frame%>% dplyr::select(c("GEOID", "lasso_pred","female", "avg_hhsize", "hispanic",
                                  "black", "kids", "elderly", "education", "employed",
                                  "married", "disability"))%>%
                  rename(
                         `Predicted Expenditure` = lasso_pred)
renderDataTable({
rbind(temp2[which(ia_shp_join$COUNTYNAME == input$county2),],
      temp2[which(ia_shp_join$COUNTYNAME != input$county2),])
  
})
```

